<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğ‘´ğ’š ğ‘¯ğ’–ğ’ğ’•ğ’†ğ’“ | Ø´Ú©Ø§Ø±Ú†ÛŒ Ù…Ù†</title>

  <meta name="theme-color" content="#2c3e50" />

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <script src="https://miniapp.bale.ai/sdk.js"></script>

  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 0;
      background: #ecf0f1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: #2c3e50;
      color: #fff;
      padding: 15px;
      text-align: center;
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .page { display: none; }
    .page.active { display: block; }

    .content-card {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .bottom-nav {
      display: flex;
      flex-direction: row-reverse;
      border-top: 1px solid #ccc;
      background: #fff;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      cursor: pointer;
      color: #777;
    }

    .nav-item.active {
      color: #e74c3c;
    }
  </style>
</head>

<body>

<div class="header">
  <h2>ğ‘´ğ’š ğ‘¯ğ’–ğ’ğ’•ğ’†ğ’“</h2>
</div>

<div class="content">

  <div id="home-page" class="page active">
    <div class="content-card">
      <h3>Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§</h3>

      <button onclick="openAddAccount()"
              style="padding:10px 15px;border-radius:8px;background:#3498db;color:#fff;border:none;">
        â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª
      </button>

      <div id="accounts-list" style="margin-top:15px;"></div>
    </div>
  </div>

  <div id="shop-page" class="page">
    <div class="content-card">Ø¨Ø®Ø´ Ø®Ø±ÛŒØ¯</div>
  </div>

  <div id="settings-page" class="page">
    <div class="content-card">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
  </div>

  <div id="info-page" class="page">
    <div class="content-card">ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</div>
  </div>

</div>

<div class="bottom-nav">
  <div class="nav-item" data-page="home-page"><i class="fas fa-house"></i><br>Ø®Ø§Ù†Ù‡</div>
  <div class="nav-item" data-page="shop-page"><i class="fas fa-cart"></i><br>Ø®Ø±ÛŒØ¯</div>
  <div class="nav-item" data-page="settings-page"><i class="fas fa-gear"></i><br>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
  <div class="nav-item" data-page="info-page"><i class="fas fa-circle-info"></i><br>Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>
</div>

<script>
const API_BASE = "https://hunter-api-2x97.onrender.com";
let loginInProgress = false;

document.addEventListener("DOMContentLoaded", () => {
  bale.ready();

  document.querySelectorAll(".nav-item").forEach(item => {
    item.onclick = () => switchPage(item.dataset.page);
  });

  switchPage("home-page");
  loadAccounts();
});

function switchPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".nav-item").forEach(i =>
    i.classList.toggle("active", i.dataset.page === id)
  );
}

/* ---------- LOGIN ---------- */

function openAddAccount() {
  bale.showPopup({
    title: "Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª",
    message: `<input id="phoneInput" placeholder="989xxxxxxxxx"
      style="width:100%;padding:10px">`,
    buttons: [
      { text: "Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯", type: "default", onClick: sendCode },
      { text: "Ù„ØºÙˆ", type: "cancel" }
    ]
  });
}

async function sendCode() {
  if (loginInProgress) return;
  loginInProgress = true;

  const phone = document.getElementById("phoneInput").value.trim();
  if (!/^989\d{9}$/.test(phone)) {
    loginInProgress = false;
    return bale.showToast({ text: "Ø´Ù…Ø§Ø±Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±" });
  }

  try {
    const res = await bale.request({
      url: API_BASE + "/login/send-code",
      method: "POST",
      data: { phone }
    });

    if (!res.data.ok) throw new Error(res.data.error);

    bale.showToast({ text: "Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯" });
    askForCode(phone);

  } catch (e) {
    bale.showPopup({ title: "Ø®Ø·Ø§", message: e.message });
  }

  loginInProgress = false;
}

function askForCode(phone) {
  bale.showPopup({
    title: "Ú©Ø¯ ØªØ§ÛŒÛŒØ¯",
    message: `<input id="codeInput" placeholder="Ú©Ø¯ ØªØ§ÛŒÛŒØ¯"
      style="width:100%;padding:10px">`,
    buttons: [
      { text: "ØªØ§ÛŒÛŒØ¯", type: "default", onClick: () => verifyCode(phone) },
      { text: "Ù„ØºÙˆ", type: "cancel" }
    ]
  });
}

async function verifyCode(phone) {
  const code = document.getElementById("codeInput").value.trim();
  if (!code) return;

  try {
    const res = await bale.request({
      url: API_BASE + "/login/verify-code",
      method: "POST",
      data: { phone, code }
    });

    if (!res.data.ok) throw new Error(res.data.error);

    bale.closePopup();
    bale.showToast({ text: "Ø§Ú©Ø§Ù†Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯" });
    loadAccounts();

  } catch (e) {
    bale.showPopup({ title: "Ø®Ø·Ø§", message: e.message });
  }
}

/* ---------- ACCOUNTS ---------- */

async function loadAccounts() {
  const box = document.getElementById("accounts-list");
  box.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...";

  try {
    const res = await bale.request({
      url: API_BASE + "/accounts",
      method: "GET"
    });

    box.innerHTML = "";

    if (!res.data.accounts.length) {
      box.innerHTML = "Ø§Ú©Ø§Ù†ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡";
      return;
    }

    res.data.accounts.forEach(a => {
      box.innerHTML += `
        <div style="margin-top:6px">
          ğŸ“± ${a.phone}
          <span style="color:${a.online ? 'green' : 'red'}">
            (${a.online ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†' : 'Ø¢ÙÙ„Ø§ÛŒÙ†'})
          </span>
        </div>`;
    });

  } catch {
    box.innerHTML = "<span style='color:red'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª</span>";
  }
}
</script>

</body>
    </html>
