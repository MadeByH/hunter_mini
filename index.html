<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>My Hunter | Ø´Ú©Ø§Ø±Ú†ÛŒ Ù…Ù†</title>
  <meta name="theme-color" content="#2c3e50"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://miniapp.bale.ai/sdk.js"></script>

  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 0;
      background: #ecf0f1;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: #2c3e50;
      color: white;
      padding: 14px;
      text-align: center;
    }

    .content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .page { display: none; }
    .page.active { display: block; }

    .content-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
    }

    button {
      padding: 12px 18px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    ul {
      padding-right: 20px;
    }

    li {
      margin: 8px 0;
    }

    .bottom-nav {
      display: flex;
      border-top: 1px solid #ccc;
      background: white;
      direction: rtl;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      color: #7f8c8d;
      cursor: pointer;
      font-size: 11px;
    }

    .nav-item.active {
      color: #e74c3c;
    }

    .nav-item i {
      display: block;
      font-size: 20px;
      margin-bottom: 3px;
    }
  </style>
</head>

<body>

<div class="header">
  <h3>My Hunter | Ø´Ú©Ø§Ø±Ú†ÛŒ Ù…Ù†</h3>
</div>

<div class="content">

  <div id="home-page" class="page active">
    <div class="content-card">
      <h3>Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§</h3>
      <button id="addAccountBtn">â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª</button>
      <ul id="accountsList"></ul>
    </div>
  </div>

  <div id="shop-page" class="page">
    <div class="content-card">
      <h3>Ù¾Ù„Ù†â€ŒÙ‡Ø§</h3>
      <p>Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡â€¦</p>
    </div>
  </div>

  <div id="settings-page" class="page">
    <div class="content-card">
      <ul>
        <li>ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</li>
        <li>Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</li>
        <li>Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</li>
      </ul>
    </div>
  </div>

  <div id="info-page" class="page">
    <div class="content-card">
      <p>ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…: ÙØ¹Ø§Ù„ âœ…</p>
    </div>
  </div>

</div>

<div class="bottom-nav">
  <div class="nav-item active" data-page="home-page"><i class="fa fa-house"></i>Ø®Ø§Ù†Ù‡</div>
  <div class="nav-item" data-page="shop-page"><i class="fa fa-cart"></i>Ø®Ø±ÛŒØ¯</div>
  <div class="nav-item" data-page="settings-page"><i class="fa fa-gear"></i>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
  <div class="nav-item" data-page="info-page"><i class="fa fa-circle-info"></i>Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>
</div>

<script>
let currentPhone = null;

/* ---- BALE READY ---- */
bale.ready().then(() => {
  bindUI();
  loadAccounts();
});

/* ---- UI ---- */
function bindUI() {
  document.querySelectorAll(".nav-item").forEach(item => {
    item.addEventListener("click", () => switchPage(item.dataset.page));
  });

  document.getElementById("addAccountBtn")
    .addEventListener("click", openAddAccount);
}

function switchPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".nav-item").forEach(n =>
    n.classList.toggle("active", n.dataset.page === id)
  );
}

/* ---- LOGIN FLOW ---- */
function openAddAccount() {
  bale.showPopup({
    title: "Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª",
    message: `<input id="phoneInput" placeholder="989xxxxxxxxx" style="width:100%;padding:10px"/>`,
    buttons: [
      { text: "Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯", onClick: () => sendCode() },
      { text: "Ù„ØºÙˆ", type: "cancel" }
    ]
  });
}

async function sendCode() {
  const phone = document.getElementById("phoneInput").value.trim();
  if (!/^989\d{9}$/.test(phone)) {
    bale.showToast({ text: "Ø´Ù…Ø§Ø±Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø±" });
    return;
  }

  currentPhone = phone;

  const res = await fetch("https://hunter-api-2x97.onrender.com/login/send-code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone })
  });

  const data = await res.json();
  if (!data.ok) {
    bale.showToast({ text: data.error });
    return;
  }

  askForCode();
}

function askForCode() {
  bale.showPopup({
    title: "Ú©Ø¯ ØªØ§ÛŒÛŒØ¯",
    message: `<input id="codeInput" style="width:100%;padding:10px"/>`,
    buttons: [
      { text: "ØªØ§ÛŒÛŒØ¯", onClick: () => verifyCode() },
      { text: "Ù„ØºÙˆ", type: "cancel" }
    ]
  });
}

async function verifyCode() {
  const code = document.getElementById("codeInput").value.trim();

  const res = await fetch("https://hunter-api-2x97.onrender.com/login/verify-code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone: currentPhone, code })
  });

  const data = await res.json();
  if (!data.ok) {
    bale.showToast({ text: data.error });
    return;
  }

  bale.closePopup();
  bale.showToast({ text: "Ø§Ú©Ø§Ù†Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯" });
  loadAccounts();
}

/* ---- ACCOUNTS ---- */
async function loadAccounts() {
  const ul = document.getElementById("accountsList");
  ul.innerHTML = "<li>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒâ€¦</li>";

  try {
    const res = await fetch("https://hunter-api-2x97.onrender.com/accounts");
    const data = await res.json();

    ul.innerHTML = "";

    if (!data.accounts.length) {
      ul.innerHTML = "<li>Ø§Ú©Ø§Ù†ØªÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</li>";
      return;
    }

    data.accounts.forEach(a => {
      const li = document.createElement("li");
      li.innerHTML = `ğŸ“± ${a.phone} â€” <b style="color:${a.online ? 'green':'red'}">${a.online ? 'Ø¢Ù†Ù„Ø§ÛŒÙ†':'Ø¢ÙÙ„Ø§ÛŒÙ†'}</b>`;
      ul.appendChild(li);
    });

  } catch {
    ul.innerHTML = "<li style='color:red'>Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§</li>";
  }
}
</script>

</body>
  </html>
