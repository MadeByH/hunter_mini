<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>ğ‘´ğ’š ğ‘¯ğ’–ğ’ğ’•ğ’†ğ’“ | Ø´Ú©Ø§Ø±Ú†ÛŒ Ù…Ù†</title>
  <meta name="theme-color" content="#2c3e50"/>

  <!-- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Font Awesome -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <!-- SDK Ø±Ø³Ù…ÛŒ Bale MiniApp -->
  <script src="https://tapi.bale.ai/miniapp.js?3"></script>

  <style>
    body {
      font-family: Tahoma, sans-serif;
      margin: 0;
      background: #ecf0f1;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header {
      background: #2c3e50;
      color: #fff;
      padding: 14px;
      text-align: center;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      position: relative;
      z-index: 1;
      padding-bottom: 76px;
    }

    .page { display: none; }
    .page.active { display: block; }

    .content-card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .add-btn {
      padding: 10px 16px;
      background: #3498db;
      color: #fff;
      border-radius: 8px;
      text-align: center;
      user-select: none;
      cursor: pointer; /* Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ© Ø¨ÙˆØ¯Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ */
    }

    .bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;

  display: flex;              /* âœ… Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù… */
  flex-direction: row-reverse;/* RTL */
  justify-content: space-around;
  align-items: center;

  background: #fff;
  border-top: 1px solid #ccc;
  z-index: 100;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 8px 0;
      color: #777;
      cursor: pointer;
      font-size: 11px;
      pointer-events: auto;
    }

    .nav-item.active { color: #e74c3c; }
    .nav-item i {
      font-size: 20px;
      display: block;
      margin-bottom: 4px;
    }

    ul { padding-right: 20px; }
    li { margin-bottom: 6px; }

    /* === Modal === */
    #addModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    #addModal .modal-content {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      width: 85%;
      max-width: 400px; /* Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø¹Ø±Ø¶ Ø¯Ø± ØµÙØ­Ù‡ Ø¨Ø²Ø±Ú¯ */
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #addModal .modal-content h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    #addModal input {
      box-sizing: border-box;
      width: 100%;
      padding: 8px;
      padding-right: 8px;
      padding-left: 12px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      direction: ltr; /* ØªÙ†Ø¸ÛŒÙ… Ø¬Ù‡Øª Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¹Ø¯Ø¯ÛŒ */
      text-align: left;
    }

    #addModal .btn-row {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    #addModal .add-btn.cancel {
      background: #aaa;
    }

    #verifyModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

    #verifyModal .modal-content {
  background: #fff;
  padding: 16px;
  border-radius: 10px;
  width: 85%;
  max-width: 400px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    #verifyModal input {
  box-sizing: border-box;
  width: 100%;
  padding: 10px;
  font-size: 16px;        /* Ø®ÙˆØ§Ù†Ø§ØªØ± */
  border-radius: 8px;
  border: 1px solid #ccc;
  text-align: center;
  direction: ltr;
  margin-bottom: 14px;
}

    #verifyModal .btn-row {
  display: flex;
  gap: 10px;
}

    #verifyModal .add-btn {
  flex: 1;
  padding: 10px 0;        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ú©ÙˆÚ†ÛŒÚ©â€ŒØªØ± */
  font-size: 14px;
}

    body.dark {
  background:#121212;
  color:#eee;
}

    body.dark .header {
  background:#1e1e1e;
}

    body.dark .content-card {
  background:#1f1f1f;
  box-shadow:none;
}

    body.dark .bottom-nav {
  background:#1e1e1e;
  border-color:#333;
}

    body.dark .nav-item {
  color:#aaa;
      }
    body.dark .nav-item.active {
  color: #ff8c42; /* Ù†Ø§Ø±Ù†Ø¬ÛŒ Ù…Ù„Ø§ÛŒÙ…â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø´Ø¨ */
}

    .modal-box {
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  width: 85%;
  max-width: 360px;
  text-align: center;
  color: #333;
}

    body.dark .modal-box {
  background: #1f1f1f;
  color: #eee;
}
    
    body.dark #msgText,
    body.dark #confirmText {
  color: #eee;
}
    body.dark #msgModal .add-btn {
  background: #ff8c42;
}

    #msgModal,
    #confirmModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}
    
    .knob-container {
  position: relative;
  width: 180px;
  margin: 20px auto;
}

    .knob-value {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: bold;
  pointer-events: none;
}

    .speed-range {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #777;
}

    .content-card.small {
  padding: 12px;
}

    .expand-btn {
  cursor: pointer;
  font-size: 14px;
  color: #3498db;
      }

    body.dark textarea,
    body.dark input[type="number"] {
  background:#2a2a2a;
  color:#eee;
  border-color:#444;
}

    .locked {
  opacity: 0.5;
  pointer-events: none;
}

    .plan-card {
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 14px;
}

    .plan-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

    .plan-card ul {
  padding-right: 18px;
  margin: 6px 0 10px;
}

    .buy-btn {
  width: 100%;
  padding: 8px;
  border: none;
  border-radius: 8px;
  background: #27ae60;
  color: #fff;
  font-size: 13px;
  cursor: pointer;
}

    .buy-btn.disabled {
  background: #aaa;
  cursor: default;
}

    .plan-card.free { border-color: #ccc; }
    .plan-card.bronze { border-color: #cd7f32; }
    .plan-card.silver { border-color: #bdc3c7; }
    .plan-card.gold { border-color: #f1c40f; }
    
    canvas {
  touch-action: none;
}
    
  </style>
</head>

<body>
  <!-- Header -->
  <div class="header"><h3>ğ‘´ğ’š ğ‘¯ğ’–ğ’ğ’•ğ’†ğ’“ | Ø´Ú©Ø§Ø±Ú†ÛŒ Ù…Ù†</h3></div>

  <!-- Content -->
  <div class="content">
    <div id="home-page" class="page active">
      <div class="content-card">
        <h3>Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§</h3>
        <div class="add-btn" ontouchstart="openAddAccount()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª</div>
        <ul id="accounts-list"></ul>
      </div>
    </div>

    <div id="shop-page" class="page">
      <div class="content-card">
        <h3>ğŸ’ Ø§Ø±ØªÙ‚Ø§ÛŒ Ù¾Ù„Ù†</h3>

        <div class="plan-card free">
          <div class="plan-header">
            <strong>FREE</strong>
            <span class="price">Ø±Ø§ÛŒÚ¯Ø§Ù†</span>
          </div>
          <ul>
            <li>â± Ø­Ø¯Ø§Ù‚Ù„ Ø³Ø±Ø¹Øª: 1.05s</li>
            <li>ğŸ“± Û± Ø§Ú©Ø§Ù†Øª</li>
            <li>ğŸ™ ØªØ´Ú©Ø± Ø®ÙˆØ¯Ú©Ø§Ø± âŒ</li>
          </ul>
          <button disabled class="buy-btn disabled">Ù¾Ù„Ù† ÙØ¹Ù„ÛŒ</button>
        </div>

        <div class="plan-card bronze">
          <div class="plan-header">
            <strong>BRONZE</strong>
            <span class="price">49,000 ØªÙˆÙ…Ø§Ù†</span>
          </div>
          <ul>
            <li>â± Ø­Ø¯Ø§Ù‚Ù„ Ø³Ø±Ø¹Øª: 0.65s</li>
            <li>ğŸ“± Û· Ø§Ú©Ø§Ù†Øª</li>
            <li>ğŸ™ ØªØ´Ú©Ø± Ø®ÙˆØ¯Ú©Ø§Ø± âœ…</li>
          </ul>
          <button class="buy-btn" onclick="buyPlan('BRONZE')">Ø®Ø±ÛŒØ¯</button>
        </div>

        <div class="plan-card silver">
          <div class="plan-header">
            <strong>SILVER</strong>
            <span class="price">89,000 ØªÙˆÙ…Ø§Ù†</span>
          </div>
          <ul>
            <li>â± Ø­Ø¯Ø§Ù‚Ù„ Ø³Ø±Ø¹Øª: 0.5s</li>
            <li>ğŸ“± Û±Û° Ø§Ú©Ø§Ù†Øª</li>
            <li>ğŸ™ ØªØ´Ú©Ø± Ø®ÙˆØ¯Ú©Ø§Ø± âœ…</li>
          </ul>
          <button class="buy-btn" onclick="buyPlan('SILVER')">Ø®Ø±ÛŒØ¯</button>
        </div>

        <div class="plan-card gold">
          <div class="plan-header">
            <strong>GOLD</strong>
            <span class="price">149,000 ØªÙˆÙ…Ø§Ù†</span>
          </div>
          <ul>
            <li>â± Ø­Ø¯Ø§Ù‚Ù„ Ø³Ø±Ø¹Øª: 0.35s</li>
            <li>ğŸ“± Û±Ûµ Ø§Ú©Ø§Ù†Øª</li>
            <li>ğŸ™ ØªØ´Ú©Ø± Ø®ÙˆØ¯Ú©Ø§Ø± âœ…</li>
          </ul>
          <button class="buy-btn" onclick="buyPlan('GOLD')">Ø®Ø±ÛŒØ¯</button>
        </div>

      </div>
    </div>

    <div id="settings-page" class="page">
      <div class="content-card">
        <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>

        <label style="display:flex;justify-content:space-between;align-items:center">
          <span>ğŸŒ™ Ø­Ø§Ù„Øª Ø´Ø¨</span>
          <input type="checkbox" id="darkToggle" onchange="toggleDarkMode(this)">
        </label>
      </div>

      <div class="content-card">
        <h3>ğŸ“² Ø§Ú©Ø§Ù†Øª ÙØ¹Ù„ÛŒ:</h3>
        <p>
    Ù¾Ù„Ù† Ø´Ù…Ø§:
          <strong id="userPlanLabel">FREE</strong>
        </p>
      </div>
      
      <div class="content-card">
        <h3>âš¡ Ø³Ø±Ø¹Øª Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ø§Ú©Øª</h3>

        <div class="knob-container">
          <canvas id="speedKnob" width="180" height="180"></canvas>
          <div class="knob-value" id="knobValue">2.5s</div>
        </div>

        <div class="speed-range">
          <span id="maxSpeed">10s</span>
          <span id="minSpeed">1.05s</span>
        </div>
      </div>

  <!-- Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ± -->
      <div class="content-card small" id="moreAccounts" style="display:none">
        <div class="expand-btn" onclick="toggleMoreAccounts(this)">
      â–¸ Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±
        </div>

        <div id="accountsList" style="display:none"></div>
      </div>

      <div class="content-card">
        <h3>ğŸ™ ØªØ´Ú©Ø± Ø®ÙˆØ¯Ú©Ø§Ø±</h3>

        <label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <span>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</span>
          <input type="checkbox" id="thanksEnabled" onchange="saveThanksSettings()">
        </label>

        <div id="thanksBox">
          <textarea
      id="thanksText"
      placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ù…Ù†ÙˆÙ† ğŸ™"
      style="width:100%;min-height:60px;border-radius:8px;border:1px solid #ccc;padding:8px;margin-bottom:10px"
    ></textarea>

          <label style="font-size:13px">
      â± ØªØ§Ø®ÛŒØ± Ø§Ø±Ø³Ø§Ù„ (Ø«Ø§Ù†ÛŒÙ‡)
            <input
        type="number"
        id="thanksDelay"
        min="0"
        step="0.5"
        value="7"
        style="width:100%;margin-top:6px;border-radius:8px;border:1px solid #ccc;padding:6px"
        onchange="saveThanksSettings()"
      >
          </label>
        </div>

        <div id="thanksLocked"
       style="display:none;margin-top:10px;color:#e74c3c;font-size:13px">
    ğŸ”’ Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª ÙÙ‚Ø· Ø¯Ø± Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆÙ„ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª
        </div>
      </div>
      
    </div>

    <div id="info-page" class="page">
      <div class="content-card">
        <h3>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø§Ú©Ø§Ù†Øª</h3>
        <p>Ù¾Ù„Ù† ÙØ¹Ø§Ù„: <strong id="infoPlan">FREE</strong></p>
        <p>ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…: <span style="color:#27ae60">ÙØ¹Ø§Ù„</span></p>
      </div>
      <div class="content-card">
        <h3>ğŸ Ø¢Ù…Ø§Ø± Ù¾Ø§Ú©Øªâ€ŒÙ‡Ø§</h3>

        <div style="display:flex;justify-content:space-between">
          <div>
            <strong id="todayCount">0</strong><br>
            <small>Ø§Ù…Ø±ÙˆØ²</small>
          </div>
          <div>
            <strong id="weekCount">0</strong><br>
            <small>Û· Ø±ÙˆØ² Ø§Ø®ÛŒØ±</small>
          </div>
          <div>
            <strong id="totalCount">0</strong><br>
            <small>Ú©Ù„</small>
          </div>
        </div>
      </div>
      <div class="content-card">
        <h3>â„¹ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø±Ù†Ø§Ù…Ù‡</h3>
        <p>Ù†Ø³Ø®Ù‡: 1.2.0</p>
        <p>Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸ ØªÙˆØ³Ø· ğ˜”ğ˜¢ğ˜¥ğ˜¦ ğ˜‰ğ˜º ğ˜</p>
      </div>
    </div>

  <!-- Bottom Nav -->
  <div class="bottom-nav">
    <div class="nav-item active" data-page="home-page"><i class="fas fa-house"></i>Ø®Ø§Ù†Ù‡</div>
    <div class="nav-item" data-page="shop-page"><i class="fas fa-cart-shopping"></i>Ø®Ø±ÛŒØ¯</div>
    <div class="nav-item" data-page="settings-page"><i class="fas fa-gear"></i>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
    <div class="nav-item" data-page="info-page"><i class="fas fa-circle-info"></i>Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>
  </div>

  <!-- Modal Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª -->
  <div id="addModal">
    <div class="modal-content">
      <h3>Ø§ÙØ²ÙˆØ¯Ù† Ø§Ú©Ø§Ù†Øª</h3>
      <input id="phoneInput" placeholder="Ù…Ø«Ù„Ø§Ù‹ 989 - Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†xxxxxxxxx" dir="ltr" type="tel" maxlength="12">
      <div class="btn-row">
        <div class="add-btn" id="sendCodeBtn" ontouchstart="sendCode()">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯</div>
        <div class="add-btn cancel" ontouchstart="closeModal()">Ù„ØºÙˆ</div>
      </div>
    </div>
  </div>

    <!-- Modal Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ -->
  <div id="verifyModal">
    <div class="modal-content">
      <h3 id="verifyModalTitle"></h3>
      <input id="codeInputInternal" placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ" dir="ltr" type="tel" maxlength="6">
      <div class="btn-row">
        <div class="add-btn" ontouchstart="handleVerifySubmit()">ØªØ§ÛŒÛŒØ¯</div>
        <div class="add-btn cancel" ontouchstart="closeVerifyModal()">Ù„ØºÙˆ</div>
      </div>
    </div>
  </div>

  <div id="msgModal">
    <div class="modal-box">
  
    <div id="msgText" style="margin-bottom:16px;font-size:14px;"></div>
    <div class="add-btn" onclick="closeMsg()">ØªØ§ÛŒÛŒØ¯</div>
  </div>
</div>

  <div id="confirmModal">
    <div class="modal-box">
  
    <div id="confirmText" style="margin-bottom:18px;font-size:14px;"></div>

    <div style="display:flex;gap:10px">
      <div class="add-btn cancel" onclick="closeConfirm()">Ù„ØºÙˆ</div>
      <div class="add-btn" style="background:#e74c3c" onclick="confirmDelete()">Ø­Ø°Ù</div>
    </div>
  </div>
</div>
  
  <script>
    /* ============== Init Bale MiniApp & Globals ============== */
    const WebApp = window.Bale?.WebApp;
    
    if (WebApp) {
      WebApp.ready();
      WebApp.expand();
      WebApp.BackButton.show("close");
    } else {
      // Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¨Ù„Ù‡
      showModal("MiniApp API Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§Ø² Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
    }

    const API_BASE = "https://hunter-api-2x97.onrender.com"; // ğŸ‘ˆ Ø§ÛŒÙ† Ø­Ø§Ù„Ø§ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ Ø§Ø³Øª.
    let currentPhone = "";
    let sending = false;
    let accounts = [];
    let userPlan = "FREE"; // Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ø² API Ù…ÛŒØ§Ø¯
    
    const INIT_DATA = WebApp.initData;
    const user = WebApp?.initDataUnsafe?.user;

    function showModal(text) {
  document.getElementById("msgText").innerText = text;
  document.getElementById("msgModal").style.display = "flex";
}

    function closeMsg() {
  document.getElementById("msgModal").style.display = "none";
}

    let deletePhone = null;

    function showConfirm(phone) {
  deletePhone = phone;
  document.getElementById("confirmText").innerText =
    "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø§Ú©Ø§Ù†Øª Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\n" + phone;
  document.getElementById("confirmModal").style.display = "flex";
}

    function closeConfirm() {
  deletePhone = null;
  document.getElementById("confirmModal").style.display = "none";
}

    async function confirmDelete() {
  if (!deletePhone) return;

  try {
    const res = await fetch(
      `${API_BASE}/accounts/${deletePhone}?user_id=${user.id}`,
      { method: "DELETE" }
    );

    const data = await res.json();

    if (!data.ok) {
      showModal(data.error || "Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ú©Ø§Ù†Øª");
    } else {
      showModal("âœ… Ø§Ú©Ø§Ù†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯");
      loadAccounts();
    }
  } catch (e) {
    showModal("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
  } finally {
    closeConfirm();
  }
}

    function toggleDarkMode(el) {
  if (el.checked) {
    document.body.classList.add("dark");
    localStorage.setItem("theme", "dark");
  } else {
    document.body.classList.remove("dark");
    localStorage.setItem("theme", "light");
  }
}

// Ø§Ø¹Ù…Ø§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯
    (function initTheme() {
  const theme = localStorage.getItem("theme");
  if (theme === "dark") {
    document.body.classList.add("dark");
    const toggle = document.getElementById("darkToggle");
    if (toggle) toggle.checked = true;
  }
})();

    const canvas = document.getElementById("speedKnob");
    const ctx = canvas.getContext("2d");

    let minSpeed = 1.05;   // Ø§Ø² Ù¾Ù„Ù† Ù…ÛŒØ§Ø¯
    let maxSpeed = 10;
    let value = 2.5;
    let activePhone = null;
    const PLAN_SPEED = {
  FREE: 1.05,
  PRO: 1,
  VIP: 0.8,
  BRONZE: 0.65,
  SILVER: 0.5,
  GOLD: 0.35,
  PLATINUM: 0.2,
  DIAMOND: 0.05
};

    function drawKnob() {
  ctx.clearRect(0,0,180,180);

  const isDark = document.body.classList.contains("dark");
  const cx = 90, cy = 90, r = 70;

  ctx.lineWidth = 10;

  // arc background
  ctx.strokeStyle = isDark ? "#444" : "#ddd";
  ctx.beginPath();
  ctx.arc(cx, cy, r, Math.PI*0.75, Math.PI*2.25);
  ctx.stroke();

  // active arc
  const percent = (value - minSpeed) / (maxSpeed - minSpeed);
  ctx.strokeStyle = isDark ? "#ff8c42" : "#e67e22";
  ctx.beginPath();
  ctx.arc(
    cx, cy, r,
    Math.PI*0.75,
    Math.PI*0.75 + percent * Math.PI*1.5
  );
  ctx.stroke();

  document.getElementById("knobValue").innerText = value.toFixed(1) + "s";
    }

    drawKnob();

    function toggleMoreAccounts(btn) {
  const el = document.getElementById("accountsList");
  const open = el.style.display === "block";
  el.style.display = open ? "none" : "block";
  btn.innerText = open ? "â–¸ Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±" : "â–¾ Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¨ÛŒØ´ØªØ±";
    }

    let dragging = false;

    canvas.addEventListener("mousedown", (e) => {
  dragging = true;
  handleKnobMove(e.clientX, e.clientY);
});

    canvas.addEventListener("mouseup", () => dragging = false);
    canvas.addEventListener("mouseleave", () => dragging = false);

    canvas.addEventListener("mousemove", (e) => {
  if (!dragging) return;
  handleKnobMove(e.clientX, e.clientY);
});

/* ===== Ù…ÙˆØ¨Ø§ÛŒÙ„ / Bale ===== */

    canvas.addEventListener("touchstart", (e) => {
  dragging = true;
  const t = e.touches[0];
  handleKnobMove(t.clientX, t.clientY);
});

    canvas.addEventListener("touchend", () => dragging = false);

    canvas.addEventListener("touchmove", (e) => {
  if (!dragging) return;
  e.preventDefault(); // Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„
  const t = e.touches[0];
  handleKnobMove(t.clientX, t.clientY);
}, { passive: false });

    function selectAccount(phone) {
  activePhone = phone;

  // Ù„ÙˆØ¯ Ø³Ø±Ø¹Øª Ù…Ø®ØµÙˆØµ Ù‡Ù…ÛŒÙ† Ø§Ú©Ø§Ù†Øª
  const saved = localStorage.getItem(`speed_${phone}`);
  value = saved ? Number(saved) : minSpeed;

  drawKnob();
    }
    
    function handleKnobMove(xClient, yClient) {
  const rect = canvas.getBoundingClientRect();
  const x = xClient - rect.left - 90;
  const y = yClient - rect.top - 90;

  let angle = Math.atan2(y, x);
  angle = Math.max(-Math.PI*0.75, Math.min(Math.PI*0.75, angle));

  const percent = (angle + Math.PI*0.75) / (Math.PI*1.5);
  value = Math.max(
  minSpeed,
  minSpeed + percent * (maxSpeed - minSpeed)
);
  if (!activePhone) {
  showModal("Ø§ÙˆÙ„ ÛŒÚ© Ø§Ú©Ø§Ù†Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");
  return;
    }

  localStorage.setItem(`speed_${activePhone}`, value.toFixed(2));
      
  clearTimeout(window.speedTimer);
  window.speedTimer = setTimeout(() => {
  
  if (!accounts.length) return;
  fetch(
  `${API_BASE}/accounts/${activePhone}/speed?user_id=${user.id}&speed=${value}`,
  { method: "POST" }
);
}, 400);
      
  drawKnob();
                   }

    value = Number(localStorage.getItem(`speed_${activePhone}`)) || 2.5;
    drawKnob();

    function renderUserPlan() {
  const el = document.getElementById("userPlanLabel");
  el.innerText = userPlan;

  if (userPlan !== "FREE") {
    el.style.color = "#27ae60";
  } else {
    el.style.color = "#e74c3c";
  }
}

    async function loadUserSettings() {
  const res = await fetch(
    `${API_BASE}/user/settings?user_id=${user.id}`
  );
  const data = await res.json();

  userPlan = data.plan || "FREE";

  document.getElementById("userPlanLabel").innerText = userPlan;

  // Ø±Ù†Ú¯ Ù¾Ù„Ù†
  const el = document.getElementById("userPlanLabel");
  el.style.color = userPlan === "FREE" ? "#e74c3c" : "#27ae60";

  applyPlanLimits();
    }

    function applyPlanLimits() {
  minSpeed = PLAN_SPEED[userPlan] || 1.05;
  document.getElementById("minSpeed").innerText = minSpeed + "s";
  document.getElementById("maxSpeed").innerText = maxSpeed + "s";
  drawKnob();
    }
    
    async function loadThanksSettings() {
  try {
    const res = await fetch(`${API_BASE}/settings?user_id=${user.id}`);
    const data = await res.json();

    const enabled = data.auto_thanks;
    document.getElementById("thanksEnabled").checked = enabled;
    document.getElementById("thanksText").value = data.thanks_text || "";
    document.getElementById("thanksDelay").value = data.thanks_delay || 7;
    document.getElementById("minSpeed").innerText = minSpeed + "s";
    document.getElementById("maxSpeed").innerText = maxSpeed + "s";

    drawKnob();
    applyThanksPlanRules();
    renderUserPlan();
  } catch (e) {
    console.error(e);
  }
      }

    function applyThanksPlanRules() {
  const box = document.getElementById("thanksBox");
  const lock = document.getElementById("thanksLocked");
  const toggle = document.getElementById("thanksEnabled");

  if (userPlan === "FREE") {
    toggle.checked = false;
    box.classList.add("locked");
    toggle.disabled = true;
    lock.style.display = "block";
  } else {
    box.classList.remove("locked");
    toggle.disabled = false;
    lock.style.display = "none";
  }
    }

    async function saveThanksSettings() {
  if (userPlan === "FREE") {
    showModal("âŒ Ù¾Ù„Ù† Ø´Ù…Ø§ Ø§Ø² ØªØ´Ú©Ø± Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
    return;
  }

  const enabled = document.getElementById("thanksEnabled").checked;
  const text = document.getElementById("thanksText").value.trim();
  const delay = parseFloat(document.getElementById("thanksDelay").value);

  try {
    await fetch(`${API_BASE}/settings/thanks`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: user.id,
        enabled,
        text,
        delay
      })
    });

    showModal("âœ… ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯");
  } catch {
    showModal("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª");
  }
}

    /* ============== plan shop ============== */
    function buyPlan(plan) {
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¨Ù„Ù‡ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ù¾Ù„Ù†
  const link = `https://ble.ir/myhunter_bot?start=buy_${plan}`;
  
  // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¯Ø± WebApp
  if (window.Bale && Bale.WebApp) {
    Bale.WebApp.openLink(link);

    // Ø¨Ø³ØªÙ† WebApp Ø¨Ø¹Ø¯ Ø§Ø² Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    setTimeout(() => Bale.WebApp.close(), 300);
  } else {
    // Ø§Ú¯Ø± WebApp ÙØ¹Ø§Ù„ Ù†Ø¨ÙˆØ¯ØŒ Ù¾ÛŒØ§Ù… Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù†Ø´Ø§Ù† Ø¯Ù‡Ø¯
    showModal("ğŸ›’ Ø®Ø±ÛŒØ¯ Ù¾Ù„Ù† " + plan + " Ø¨Ù‡â€ŒØ²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ğŸ˜‰");
  }
}

    async function loadStats() {
  try {
    const res = await fetch(
      `${API_BASE}/stats?user_id=${user.id}`
    );
    const data = await res.json();

    document.getElementById("todayCount").innerText = data.today ?? 0;
    document.getElementById("weekCount").innerText = data.week ?? 0;
    document.getElementById("totalCount").innerText = data.total ?? 0;

    if (userPlan === "FREE") {
  document.getElementById("weekCount").innerText = "ğŸ”’";
  document.getElementById("totalCount").innerText = "ğŸ”’";
    }
    
  } catch (e) {
    console.error(e);
  }
      }
    
    /* ============== Navigation ============== */
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');

    function switchPage(id) {
      pages.forEach(p => p.classList.remove('active'));
      document.getElementById(id)?.classList.add('active');
      navItems.forEach(n => n.classList.toggle('active', n.dataset.page === id));
    }

    navItems.forEach(n => n.addEventListener('click', () => switchPage(n.dataset.page)));
    
    // Ø§ØµÙ„Ø§Ø­ Ø¯Ú©Ù…Ù‡ Ø¨Ø±Ú¯Ø´Øª
    if (WebApp) {
        WebApp.BackButton.onClick(() => WebApp.close());
    }

    /* ============== Modal Logic ============== */
    function openAddAccount() {
  const modal = document.getElementById("addModal");
  modal.style.display = "flex";
  const input = document.getElementById("phoneInput");
  input.value = "";
  setTimeout(() => input.focus(), 200);
    }
    function closeModal() {
      document.getElementById("addModal").style.display = "none";
    }

        /* ============== Code Verify Modal Logic ============== */
    function openVerifyAccount(phone) {
      const formattedPhone = phone.substring(0, 4) + "*******" + phone.substring(10);
      document.getElementById("verifyModalTitle").textContent = "ØªØ§ÛŒÛŒØ¯ Ú©Ø¯ Ø¨Ø±Ø§ÛŒ: " + formattedPhone;
      document.getElementById("verifyModal").style.display = "flex";
        setTimeout(() => document.getElementById("codeInputInternal").focus(), 200);
    }
    function closeVerifyModal() {
      document.getElementById("verifyModal").style.display = "none";
    }

    function handleVerifySubmit() {
        // Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ú©Ø§Ù„â€ŒØ¨Ú© Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ø¨Ù„Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        verifyCodeFromModal();
    }
    
    /* ============== Validation & Send Code Logic ============== */
    function isValidPhone(phone) {
        // ØªØ¨Ø¯ÛŒÙ„ "09..." Ø¨Ù‡ Ù‚Ø§Ù„Ø¨ Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ
        if (phone.startsWith("09")) phone = "98" + phone.slice(1);
        // Ø§Ù„Ú¯ÙˆÛŒ ØµØ­ÛŒØ­: 989 (11 Ø±Ù‚Ù… Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù†)
        return /^989\d{9}$/.test(phone);
    }

    function normalizePhone(input) {
  let phone = input.trim();

  // Ø­Ø°Ù ÙØ§ØµÙ„Ù‡ Ùˆ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø¶Ø§ÙÛŒ
  phone = phone.replace(/\s+/g, "");

  // 09xxxxxxxxx  â†’ 989xxxxxxxxx
  if (/^09\d{9}$/.test(phone)) {
    return "98" + phone.slice(1);
  }

  // 989xxxxxxxxx â†’ OK
  if (/^989\d{9}$/.test(phone)) {
    return phone;
  }

  return null; // Ù†Ø§Ù…Ø¹ØªØ¨Ø±
}
    
    async function sendCode() {
  const btn = document.getElementById("sendCodeBtn");
  btn.style.pointerEvents = "none";
  btn.style.opacity = "0.6";

  if (sending) return;
  sending = true;
  
  try {
    const raw = document.getElementById("phoneInput").value;
    const phone = normalizePhone(raw);
    document.getElementById("phoneInput").value = phone;

    if (!phone) {
  showModal("Ø´Ù…Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª");
  return;
}

    const res = await fetch(API_BASE + "/login/send-code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      phone,
      owner_id: user.id
    })
  });
 
    const data = await res.json();

    if (!data.ok) {
      showModal("âŒ " + data.error);
      return;
    }

    window.currentPhone = phone;
    closeModal();
    openVerifyAccount(phone);

  } finally {
    btn.style.pointerEvents = "auto";
    btn.style.opacity = "1";
    sending = false;
  }
    }

        /* ============== Verify Code (FROM MODAL) ============== */
    async function verifyCodeFromModal() {
  const code = document.getElementById("codeInputInternal").value.trim();
  if (!code) return;

  const res = await fetch(API_BASE + "/login/verify-code", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      phone: window.currentPhone,
      code,
      owner_id: user.id
    })
  });

  const data = await res.json();

  if (!data.ok) {
    showModal("âŒ " + (data.error || "Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"));
    return;
  }

  closeVerifyModal();   // âœ… Ø§ÛŒÙ† Ø®Ø·
  showModal("âœ… Ø§Ú©Ø§Ù†Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯")
  loadAccounts();
    }
    
    /* ============== Load Accounts ============== */
    async function loadAccounts() {
      const ul = document.getElementById('accounts-list');
      ul.innerHTML = "<li>â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§...</li>";

      if (!user?.id) {
          ul.innerHTML = "<li>âš ï¸ Ø§Ù…Ú©Ø§Ù† Ø¯Ø±ÛŒØ§ÙØª Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§ Ø¨Ø¯ÙˆÙ† `owner_id` ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</li>";
          return;
      }

      try {
        const res = await fetch(`${API_BASE}/accounts?user_id=${user.id}`);
        const data = await res.json();
        accounts = data.accounts || [];

        ul.innerHTML = "";
        if (!data.accounts || !data.accounts.length) {
          ul.innerHTML = "<li>Ø§Ú©Ø§Ù†ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>";
          return;
        }

        data.accounts.forEach(a => {
          const li = document.createElement('li');

          li.onclick = () => selectAccount(a.phone);

          li.innerHTML = `
    ğŸ“± ${a.phone} (${a.online ? "Ø¢Ù†Ù„Ø§ÛŒÙ†" : "Ø¢ÙÙ„Ø§ÛŒÙ†"})
    <span style="float:left;color:red;cursor:pointer"
          onclick="event.stopPropagation(); showConfirm('${a.phone}')">ğŸ—‘</span>

    <input type="checkbox"
      ${a.online ? "checked" : ""}
      onchange="event.stopPropagation(); toggleBot('${a.phone}', this)">
  `;

          ul.appendChild(li);
        });

        const moreCard = document.getElementById("moreAccounts");
        const list = document.getElementById("accountsList");

        list.innerHTML = "";

        if (accounts.length > 1) {
  moreCard.style.display = "block";

  accounts.slice(1).forEach(acc => {
    const div = document.createElement("div");
    div.style.padding = "6px 0";
    div.innerHTML = `ğŸ“± ${acc.phone} â€“ ÙˆÙ„ÙˆÙ… ØªÙ†Ø¸ÛŒÙ…`;
    list.appendChild(div);
  });
} else {
  moreCard.style.display = "none";
                              }
        
      } catch (e) {
        console.error(e);
        ul.innerHTML = "<li style='color:red'>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ú©Ø§Ù†Øªâ€ŒÙ‡Ø§.</li>";
      }
      if (accounts.length) {
  selectAccount(accounts[0].phone);
}
    }


    async function toggleBot(phone, checkbox) {
  checkbox.disabled = true;

  try {
    const res = await fetch(
  `${API_BASE}/accounts/${phone}/toggle?user_id=${user.id}`
);

    if (!res.ok) {
      const errorData = await res.json();
      showModal(`Ø®Ø·Ø§: ${errorData.error || res.statusText}`);
      checkbox.checked = !checkbox.checked;
    } else {
      await loadAccounts(); // âœ… ÙˆØ¶Ø¹ÛŒØª Ø¢Ù†Ù„Ø§ÛŒÙ†/Ø¢ÙÙ„Ø§ÛŒÙ† ÙÙˆØ±Ø§Ù‹ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒØ´Ù‡
    }

  } catch (e) {
    console.error(e);
    showModal("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±");
    checkbox.checked = !checkbox.checked;
  } finally {
    checkbox.disabled = false;
  }
    }
    
    // Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    if (WebApp) {
        loadUserSettings();
        loadAccounts();
        loadThanksSettings();
        loadStats();
    }
  </script>
</body>
</html>
